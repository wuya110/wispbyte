#!/bin/bash
# =========================================
# 一键部署 Xray SOCKS5 并生成公网可用链接
# =========================================
set -uo pipefail

# 配置
PORT=${SERVER_PORT:-${1:-9004}}
USER=${SOCKS_USER:-user}
PASS=${SOCKS_PASS:-pass}
BIN="./xray"
CONFIG="socks5.json"
LINK_FILE="socks5_link.txt"

# 获取公网 IP
IP=$(curl -s https://api64.ipify.org || echo "127.0.0.1")
echo "Detected public IP: $IP"

# 下载 Xray
if [[ ! -x "$BIN" ]]; then
    echo "Downloading Xray..."
    curl -L -o xray.zip "https://github.com/XTLS/Xray-core/releases/download/v1.8.23/Xray-linux-64.zip"
    unzip -j xray.zip xray -d . >/dev/null 2>&1
    rm -f xray.zip
    chmod +x "$BIN"
fi

# 生成配置，绑定公网 IP
cat > "$CONFIG" <<EOF
{
  "log": { "loglevel": "warning" },
  "inbounds": [{
    "port": $PORT,
    "protocol": "socks",
    "settings": {
      "auth": "password",
      "accounts": [{"user":"$USER","pass":"$PASS"}],
      "udp": true,
      "ip": "0.0.0.0"
    }
  }],
  "outbounds": [{"protocol":"freedom"}]
}
EOF

# 生成 SOCKS5 链接
echo "socks5://$USER:$PASS@$IP:$PORT" > "$LINK_FILE"
echo "========================================="
echo "Your SOCKS5 Link (public IP, ready for use):"
cat "$LINK_FILE"
echo "========================================="

# 启动 Xray
echo "Starting SOCKS5 on :$PORT..."
"$BIN" run -c "$CONFIG"